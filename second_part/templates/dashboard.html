{% extends "base.html" %}
{% block title %}Dashboard - Athlete {{ athlete_id }}{% endblock %}

{% block content %}
<h1>Dashboard for Athlete {{ athlete_id }}</h1>

<!-- Graph Type Selector -->
<div class="mt-4">
  <label for="graph-type-select">Select Graph:</label>
  <select id="graph-type-select" onchange="changeGraphType()">
    <!-- Set volume as the default selection -->
    <option value="volume" selected>Running Volume</option>
    <option value="timeSeries">Run Distances Over Time</option>
  </select>
</div>

<!-- Time Series Chart Container (hidden by default) -->
<div id="time-series-chart-container" style="display:none;">
  <div id="time-series-chart" style="width:100%;height:500px;"></div>
</div>

<!-- Volume Chart Container (visible by default) -->
<div id="volume-chart-container">
  <h3>Running Volume</h3>
  <label for="granularity-select">Granularity:</label>
  <select id="granularity-select">
    <option value="weekly" selected>Weekly</option>
    <option value="monthly">Monthly</option>
  </select>
  <label for="volume-start-date">Start Date:</label>
  <input type="date" id="volume-start-date">
  <label for="volume-end-date">End Date:</label>
  <input type="date" id="volume-end-date">
  <button onclick="loadVolumeChart()">Load Volume Chart</button>
  <div id="volume-chart" style="width:100%;height:500px;"></div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  var athleteId = "{{ athlete_id }}";

  // On page load, set default date values: January 1st to today.
  window.onload = function() {
    var today = new Date();
    var yyyy = today.getFullYear();
    var mm = String(today.getMonth() + 1).padStart(2, '0'); // Month is zero-indexed.
    var dd = String(today.getDate()).padStart(2, '0');
    // Format today's date in yyyy-mm-dd
    var todayStr = yyyy + '-' + mm + '-' + dd;
    // Set start date to January 1 of current year
    var startDateStr = yyyy + '-01-01';
    document.getElementById('volume-start-date').value = startDateStr;
    document.getElementById('volume-end-date').value = todayStr;
    // Load volume chart automatically
    loadVolumeChart();
  };

  // Function to switch between graphs
  function changeGraphType() {
    var type = document.getElementById('graph-type-select').value;
    if (type === 'timeSeries') {
      document.getElementById('time-series-chart-container').style.display = '';
      document.getElementById('volume-chart-container').style.display = 'none';
    } else if (type === 'volume') {
      document.getElementById('time-series-chart-container').style.display = 'none';
      document.getElementById('volume-chart-container').style.display = '';
    }
  }

  // Function to load the Running Volume chart
  function loadVolumeChart() {
    var granularity = document.getElementById('granularity-select').value;
    var startDate = document.getElementById('volume-start-date').value;
    var endDate = document.getElementById('volume-end-date').value;
    fetch('/api/volume-data/' + athleteId + '?granularity=' + granularity + '&start_date=' + startDate + '&end_date=' + endDate)
      .then(response => response.json())
      .then(data => {
           var periods = data.map(item => item.period);
           var distances = data.map(item => item.distance_km);
           var trace = {
               x: periods,
               y: distances,
               type: 'bar'
           };
           var layout = {
               title: 'Running Volume (' + granularity + ')',
               xaxis: { title: granularity === 'monthly' ? 'Month' : 'Week' },
               yaxis: { title: 'Distance (km)' }
           };
           Plotly.newPlot('volume-chart', [trace], layout);
      })
      .catch(error => console.error('Error loading volume chart:', error));
  }
</script>
{% endblock %}
